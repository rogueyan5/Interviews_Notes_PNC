# 规划控制通用知识
## 1.为什么需要使用四元数？什么是万向锁现象？
三维空间刚体的旋转可以由两种方式来表示，一种是任何一个旋转可以表示为依次绕着三个旋转轴三个角度的组合，这三个角度称为欧拉角，另一种是任何一个旋转可以用绕三维空间的某个轴旋转过某个角度来表示。<br>
四元数的最直观几何意义即是，将绕坐标轴的多次旋转等效为绕某一轴旋转一定角度，不管是roll、pitch、yaw还是欧拉角，都可以用四元数来替代表达。<br>
意义：
1. 因为欧拉角的表示方式不唯一，在给定某个起始方向和目标方向时，即使给定yaw pitch roll的顺序，也可以通过不同的yaw/pitch/roll的角度组合来实现所需的旋转，这是由于万向锁引起的
2. 欧拉角的插值比较难
3. 计算旋转变换时，一般需要转换成旋转矩阵，这时候需要计算很多sin和cos，计算量较大，替换为四元数后，和旋转矩阵可以等价，但是表示方式更紧凑，计算量也较小。

## 2.Apollo目前的控制算法存在哪些问题？
1. 在LQR/MPC的车辆模型中，随着加速度的变化可以对车辆模型的参数矩阵做实时调整(lf lr Cf Cr会随着载荷转移而变化)
2. MPC控制器可以考虑引入增量式模型，这样可以对控制量的变化率作约束，提高车辆的稳定性，同时可以设计更多的评价指标增加平顺性
3. 横向误差的计算选取的是匹配点，而纵向误差的计算选取的是根据时间戳得到的参考点，二者的不一致会不会造成不好的影响？
4. 在MPC控制器中，方向盘转角前馈控制设计不能使得稳态误差为0，计算二次规划问题时引入参考曲率项可以消除稳态误差（变为非线性优化问题计算量大大增加？）；选取的MPC类型是Standard MPC，标准MPC是可能存在问题的。

## 3.Apollo中横向误差的计算选取的是匹配点，而纵向误差的计算选取的是根据时间戳得到的参考点，二者的不一致会不会造成不好的影响？


## 4.什么是转向不足和转向过度？
- 中性转向：当汽车的转向盘转到一个固定的转角后保持不动，改变汽车的行驶速度，此时汽车的转向半径与理论转向半径相比较，转向半径保持不变，称为中性转向

- 转向过度：当汽车的转向盘转到一个固定的转角后保持不动，改变汽车的行驶速度，此时汽车的转向半径与理论转向半径相比较，转向半径变小，称为转向过度。

- 转向不足：当汽车的转向盘转到一个固定的转角后保持不动，改变汽车的行驶速度，此时汽车的转向半径与理论转向半径相比较，转向半径变大，称为转向不足。

通过二自由度车辆动力学方程，可以计算出
$$\beta=(\frac{1-\frac{mL_f}{2LL_fK_f}V^2}{1-\frac{m}{2L^2}\cdot\frac{L_FK_f-L_rK_r}{K_fK_r}V^2})\cdot\frac{L_r}{L}\delta$$
$$\omega=(\frac{1}{1-\frac{m}{2L^2}\cdot\frac{L_fK_f-L_rK_r}{K_fK_r}})\cdot\frac{V}{L}\delta$$
其中两式存在共同因子，定义：
$$A=-\frac{m}{2L^2}\cdot\frac{L_fK_f-L_rK_r}{K_fK_r}$$
A即为稳定性因子，也被称作不足/过多转向梯度，A决定了汽车到底是不足转向还是过度转向，若A > 0则车辆偏向转向不足，也叫做Under Steer；A = 0则称作中性转向Neutral Steer；若A < 0则称作过度转向，Over Steer。
$$R=(1+AV^2)\frac{L}{\delta}$$
- 当A = 0的时候，半径只取决于轴距与方向盘转角之比，与车速完全无关，只要方向盘转角保持不变，不论车速快还是慢，运动半径保持不变。
- 当A > 0的时候，随着车速增加，$(1+AV^2)$ 这一项也随之增加，因此总的运动半径也就随之增加，换句话说，如果你驾驶的是一辆具有不足转向特性（US）的车辆，即使你的方向盘转角保持不变，当你加速的时候，车辆会向圆周的外侧冲出去；
- 当A < 0的时候，随着车速增加，​$(1+AV^2)$ 这一项是减小的，因此车辆的运行半径也会随着车速增加而减小，也就是说，当你驾驶一辆具有转向过度特性（OS）的车做圆周运动，虽然方向盘转角不动，但当你加速的时候，车辆会向着圆周内侧偏转。

## 5.二自由度车辆模型做了哪些假设？为什么一般选择二自由度车辆模型？

# PID控制
## 1. PID分别代表什么，各自起到什么作用，有什么缺陷？
分别代表比例积分微分控制。
- 比例控制：增大Kp可以减小调节时间，但是比例控制会降低系统的稳定性，过大的Kp可能会导致振荡和超调，单纯的比例控制无法消除静差
- 积分控制：可以消除静态误差，可能导致积分饱和，降低系统的动态响应和系统稳定性。
- 微分控制：减小超调和调节时间，改善系统动态性能，但易受到高频噪声的影响，抗干扰能力比较差

## 2. 为什么一般积分控制、微分控制不单独使用？

## 3. 什么是积分饱和，该如何解决？
积分饱和是由于执行机构存在物理上的限制，导致无法对控制信号进行完美的跟踪，从而导致控制器的积分项不断累积。
- 积分分离

- 积分遇限消弱

## 4. PID控制该如何进行参数调节？
- 衰减曲线法：首先调节Kp，将Ki和Kd置0，调节至响应曲线只有2个明显的波形，再调节Ki找到一个能使得稳态误差为0的值，最后通过Kd来控制衰减比和波形的峰值、超调量，最后根据需求的稳态值、超调量、上升时间、峰值时间等指标进行微调达到目标。
- 临界比例度法：首先增大Kp，直至曲线出现等幅振荡，将Kp缩小为1/2，比例系数基本就在这附近，随后调节Ki，逐渐增大

## 5.为什么PID控制中过大的比例系数会导致系统稳定性降低？
1. 过冲和振荡： 当比例增益设置得过高时，系统对小的偏差信号会产生大幅度的响应，导致系统的输出在偏差信号附近振荡或出现过冲现象。这种振荡和过冲会影响系统的稳定性，特别是在控制系统存在噪声或测量误差时。

2. 不稳定特征根： 在控制系统中，控制系统的稳定性通常与系统的特征根（或极点）有关。过高的比例增益可以导致特征根的实部部分变得正值，使系统不稳定。在连续时间系统中，特征根的实部部分应为负值以确保系统稳定。

# 纯追踪控制
## 1.预瞄距离是如何设计的？
预瞄距离是无人驾驶智能车实现路径跟踪的一个重要参数，预瞄距离与车速存在一定的数学关系，预瞄距离常用的计算式为：
$$l_d=Av^2+Bv+C$$
式中：v为车辆行驶速度，A、B、C为常数项
上式第一项为常数A与速度v的平方的乘积，表示车辆制动距离。其中A可表示为：
$$A=\frac{1}{2a_{max}}$$
$a_{max}$为车辆最大制动加速度<br>
上式第二项为常数B与速度v的乘积，表示车辆遇到异常情况进行反应的车辆行驶距离<br>
C表示车辆最小转弯半径


# LQR
## 1.为什么需要引入前馈控制？
因为推导出来的状态空间方程存在非线性项，和道路曲率的变化率相关，因此通过LQR反馈控制不能完全消除稳态误差，因此需要设计和道路曲率变化率相关的前馈控制器消除稳态误差。

## 2.LQR控制器有什么使用条件？如何保证LQR的稳定性？
LQR只适用于线性系统，并且要求系统能控，否则求解的控制律会不收敛。<br>
当1.Q>0或者2.Q>=0且(A,Q)可观测两个条件满足其中一个时，才能保证闭环系统是渐进稳定的。<br>

## 3.当LQR基于的模型不准确时（例如车辆工况不符合车辆模型所作的假设时），应当如何保障控制效果？
- 校正在线模型：尝试改进线性模型的准确性，包括重新估计模型参数、使用更复杂的模型、使用在线识别技术来改进模型，从而提升LQR的性能
- 采用鲁棒控制策略，例如$H_\infty$控制以处理模型的不确定性，在一定范围内即使模型不准确也能够满足要求。
- 自适应控制：自适应控制器能够根据实际系统的表现来自动调整控制策略，以适应模型的不准确性。自适应控制可以通过观察实际系统响并在线更新控制参数来改进性能。
- 扰动观测与补偿：添加扰动观测器以检测系统中的不确定性和外部扰动，并引入补偿策略来抵消这些影响。
- 使用混合控制策略：考虑将LQR与其他控制策略结合使用，以应对模型不确定性，当感知到模型不准确后，使用备用的不依赖模型的控制策略

## 4.LQR控制器的稳定性如何证明？
- 定理：若(A, B)能控，则线性二次型最优控制问题有解，最优状态反馈控制器为

$$\begin{aligned} & u=-k x=-R^{-1} B^{\top} P x \\ & \dot{x}=\left(A-R^{-1} B^{\top} P\right) x \\ & V(x)=x^{\top} P x \\ & V(x)>0 \\ & \frac{d V(x)}{d t}=x^{\top} P \dot{x}+\dot{x}^{\top} P x \\ &= x^{\top}\left[P\left(A-B R^{-1} B^{\top} P\right)+\left(A-B R^{-1} B^{\top} P\right)^{\top} P\right] x \\ &=x^{\top}\left(P A-A^{\top} P-P B R^{-1} B^{\top} P-P B R^{-1} B^{\top} P\right) x \\ &=x^{\top}\left(-Q-P B R^{-1} B^{\top} P\right) x \\ &<0\end{aligned}$$

## 5.LQR控制器的使用前提有哪些？
无限时域的LQR只适用于线性系统，并且要求系统是能控的。因为系统不是能控的，L2项在无限时域中最后是不会收敛的，所有u(t)都会使整个积分变为无穷大，没有“最优”可言。

系统不能控时LQR无法确保通过调整控制输入来实现所需的控制目标。LQR控制器的设计是基于状态反馈，它通过调整控制增益来实现状态的稳定和性能优化。但如果系统的状态空间无法被完全控制，那么即使进行状态反馈也无法达到所期望的控制目标。

# MPC
## 1.谈谈LQR和MPC有什么区别？
- 从预测时域角度，LQR一般是无限时域的最优控制，而为了简化运算，MPC一般使用有限时域
- 从求解方法角度，LQR通过求解Riccatti方程，得到线性反馈系数用于最优控制，而标准形式的MPC是将优化问题转化为二次规划问题，通过调用qp求解器进行求解
- 从适用模型角度，LQR只适用于线性模型，无法处理非线性问题；MPC则既可处理线性问题也可以处理非线性问题
- 从约束角度，最主要的区别，LQR无法在控制器中为系统设置约束，而可以设置状态量、控制量的约束是MPC的主要优势。

## 2.MPC和PID控制有什么区别？相较于PID控制有什么优势？
MPC相较于传统的PID控制，它具有优化和预测的能力，即模型预测控制是一种致力于将更长时间跨度、甚至于无穷时间的最优化控制问题，分解为若干个更短时间跨度，或者有限时间跨度的最优化控制问题，并且在一定程度上仍然追求最优解。<br>
二者的区别：
- MPC是基于模型的控制方法，；而PID是基于误差的控制方法，通过系统当前状态的误差和误差变化来生成控制输出。 
- MPC控制输入针对整个预测时域，模型描述了系统的动态行为，这允许MPC对系统的未来行为进行优化来生成控制输入，以实现性能指标的最优化；而PID是针对当前的误差情况生成当前的控制输入。

MPC由于考虑了未来的系统状态，因此能够具有更好的控制效果，同时可以为控制器添加约束，然后在计算效率上会远差于PID。

## 3.MPC中的前馈控制器是如何设计的
Apollo中的MPC仿照了LQR的写法，仍然是基于线性模型进行控制器设计，这就导致了由于误差动力学方程中的$C\dot{\theta_r}$的存在，控制器仍然存在稳态误差，在Apollo代码中是仿照LQR中的前馈控制，将和K相关的项去除当作前馈，但如此设计是存在问题的。
## 4.mpc控制器的稳定性如何证明？

## 5.标准MPC存在哪些问题？
- MPC问题可能会没有解
- 轨迹可能没法收敛到原点

# 滑模控制
## 1.滑模控制有什么特点，哪些常用的趋近率？
滑模控制存在一定的优缺点：<br>
优点:
- 强鲁棒性：滑模控制在一定程度上对于参数的不确定性、外部扰动和系统变化具有较强的鲁棒性，能够再不完全了解系统动态的情况下实现稳定控制。
- 快速响应：滑模控制的设计目标是迅速将系统状态滑动到滑模面上，因此在理论上可以实现很快的响应速度。
- 适用范围广，可以应用多种类型的系统，包括线性和非线性系统，连续和离散系统，单输入单输出系统和多输入多输出系统等。
- 无需精确模型：滑模控制不要求对系统动态建立精确模型，因此在一些实际应用中，可以简化系统建模过程。
- 实时性：滑模控制的设计和计算较为简单，适用于实时控制系统。

缺点：
- 高频振荡：滑模控制在系统状态滑动到滑膜面上的过程中可能产生高频振荡，可能影响控制系统的性能和稳定性。
- 控制输入变化大：滑模控制在系统状态滑动时需要施加较大的控制输入，这可能导致执行机构的工作量增大，甚至使系统受到损害
- 切换控制： 滑模控制的实现通常需要切换控制器，这可能引入额外的复杂性和不稳定性。
- 扰动放大： 在某些情况下，滑模控制可能会导致对扰动的放大，从而使系统受到更大的影响。
- 难以调节： 滑模控制的参数调节通常较为困难，需要经验和试验来确定合适的参数值。

# 优化问题
## 1.常见的二次规划求解器有哪些？求解原理有哪些？
osqp casadi qpoases hpipm
### 常用求解器
- osqp:

OSQP是一种用于求解凸二次规划问题的求解器，其基于交替方向乘子法(ADMM)和迭代投影算法。<br>
OSQP的求解过程包括：
1. 建立二次规划模型，首先将要求解的问题表示为二次规划模型
2. 将原问题分解为两个子问题，其一是拉格朗日乘子的更新问题，另一个是原问题的最优解问题。
3. 使用ADMM算法求解子问题，将问题分为若干个子问题，转化为对这一系列子问题的求解,ADMM算法的求解过程为：初始化变量，设置拉格朗日乘子y和对偶变量z的初始值；迭代更性，更新原变量、拉格朗日乘子、对偶变量；使用迭代投影法求解原问题的最优解。

- CasADi

CasADi适用于解决非线性优化问题，实现了符号计算和自动微分，旨在为非线性优化、模型预测控制等问题提供高效的求解工具，它不是一个专门的求解器，而是一个计算图框架，可以用于建模和求解各种数学问题，包括优化问题，它可以集成多种求解器，包括osqp。

- QPOASES

OPOASES是一种专门为嵌入式系统设计的二次规划求解器，使用内点法进行QP问题的求解。

- HPIPM

HPIPM是一种高性能优化的内点法求解器，主要用于求解图优化问题，特别是线性和二次规划问题，HPIPM采用的是内点法作为求解算法。

- QUADPROG

QUADPROG是MATLAB中的一个函数，用于求解二次规划问题。它基于一种基于积极集的算法。

### 求解算法
- 积极集法

积极集法的核心思想是通过不断更新一个活跃约束集合来逐步找到问题的最优解。<br>
求解步骤包括：
1. 问题建模：将约束优化问题表示为数学形式，包括目标函数和约束条件
2. 初始化：选择一个初始点作为可能的解，并初始化一个空的活跃约束集，在初始点处，一些约束可能不活跃，这些约束在活跃集中被排除
3. 求解子问题：在每次迭代中，解决一个子问题，该子问题是在当前活跃约束集下的一个约束优化问题。将非活跃约束对应的拉格朗日乘子设置为0，这个子问题可能是一个无约束问题，或者是一个更小规模的优化问题。
4. 更新活跃集，如果解在原始约束集内，则当前活跃集不变；如果解在某些约束上，但不在活跃集中，则将约束添加到活跃集中，如果解不满足某些约束，则将这些约束从活跃集中移除
5. 重复迭代：重复执行上述步骤34，直到找到满足一定终止条件的最优解，终止条件可以是亩变函数改进不足或约束满足程度足够高

- 内点法

内点法的核心思想是将优化问题的可行域视为一个多面体的内部，通过在多面体内部迭代逐步逼近最优解。内点法相对于传统的逐步迭代法，能够更快地接近最优解并具有全局收敛性。
求解步骤包括：
1. 问题建模：将凸优化问题表示为标准形式，把欧哦目标函数和约束条件。
2. 中心路径：内点法引入了一个中心路径的概念，这是一个连接可行域内部到最优解的路径。中心路径是一组可行点，这些点满足约束并接近可行域的边界。
3. 迭代过程：内点法在迭代过程中，通过将目标函数和约束约化到中心路径附近的线性模型，逐步逼近最优解。每次迭代都会更新当前点，使其更接近中心路径。
4. 方向选择：在每次迭代中，内点法选择一个合适的搜索方向，使目标函数减小并且满足约束，这通常涉及到求解一个线性方程，找到一个方向将当前点推向中心路径
5. 迭代终止：内点法重复执行迭代步骤，直到达到预定的终止准则，如目标函数改进不足够大或约束满足程度足够高。一旦达到终止条件，算法会输出当前点作为问题的近似最优解。

内点法的优点在于全局收敛性，并且通常能够在较少的迭代步数内获得较好的近似解，然而在每次迭代中，内点法通常需要解一个线性方程系统，可能在一些情况下导致较高的计算成本。

- ADMM交替方向乘子法

交替方向乘子法是一种用于求解带约束的优化问题的迭代算法，适用于一般的凸优化问题，包括线性规划、二次规划、稀疏优化等。ADMM的核心思想是将原始问题分解为多个子问题，并在每次迭代中交替求解这些子问题，通过引入乘子变量来确保它们保持一致。<br>
求解步骤包括：
1. 问题建模：将优化问题表示为标准形式，包括目标函数和约束条件。
2. 引入乘子变量，每个变量对应一个约束。这些乘子变量用于将约束条件和原始问题分开。
3. 交替优化：在每次迭代中，ADMM交替优化两个步骤：变量更新和乘子更新
4. 收敛性和终止准则

ADMM的优点在于它能够将大规模问题分解成多个较小规模的子问题，并且在每个子问题中只需要求解简单的优化问题，从而在一些情况下能够加速求解过程。然而，ADMM的性能可能受到子问题求解和参数选择的影响。

## 2.常见的凸优化问题求解方法有哪些？
常见的凸优化求解方法包括梯度下降法、牛顿法、内点法、交替方向乘子法、投影梯度法等。

## 3.详细描述一下梯度下降法的求解过程
- 问题建模：首先，将优化问题表示为目标函数的最小化问题。目标函数通常是一个关于待优化变量的实值函数，我们的目标是找到使目标函数最小化的变量值。

- 选择初始点：选择一个初始点作为迭代的起点。通常，初始点可以是随机选择的，或者是根据问题的特性选择的一个合适点。

- 计算梯度：在当前点计算目标函数的梯度，即函数在当前点的变化率。梯度是一个向量，它的每个分量表示对应变量的偏导数。

- 更新变量：根据梯度的方向和步长（也称为学习率），更新当前点的变量值。更新公式如下：新变量 = 当前变量 - 学习率 × 梯度，学习率控制了每次迭代的步长，过大的学习率可能导致不稳定的收敛，过小的学习率可能导致收敛速度过慢。

- 迭代：重复执行步骤 3 和步骤 4，直到满足某个终止准则。终止准则可以是目标函数的改进不足够大，梯度的范数小于某个阈值，或者达到预定的迭代次数。

- 收敛性判断：检查迭代过程是否收敛。通常通过观察目标函数值的变化趋势来判断。如果目标函数值逐渐趋于稳定，那么算法可能已经接近最优解。

梯度下降法可能会陷入局部最小值，而不是全局最小值。为了解决这个问题，可以尝试使用其他优化算法，如牛顿法、共轭梯度法等。

## 4.二次规划求解器在处理非线性约束和线性约束时有什么区别？
- 处理线性约束：线性约束是指约束条件以线性等式或不等式的形式表示。在处理线性约束时，二次规划求解器通常会直接将这些约束纳入问题的构建中。线性约束可以通过添加拉格朗日乘子来转化为目标函数中的一部分，从而与二次目标函数一起进行优化。

- 处理非线性约束：
非线性约束是指约束条件具有非线性的形式。处理非线性约束的方法因求解器和算法而异。一种常见的方法是将非线性约束转化为等式或不等式，从而构建一个等价的优化问题。这可以通过引入额外的变量和约束来实现。然后，求解器可以使用不同的技术来处理这些等价的约束，如梯度下降法、牛顿法等。

## 5.求解二次规划问题时该如何提升求解速度和求解成功率？
1. 选择适当的求解器：不同的二次规划求解器可能适用于不同类型的问题。选择一个适合问题性质的求解器可以显著影响求解速度和成功率。了解不同求解器的特点和性能，根据问题的特点进行选择。

2. 数据预处理：对输入数据进行预处理可以减小问题规模，从而加快求解速度。例如，通过数据归一化、特征缩放等方式，可以将变量的数量和范围控制在合适的范围内。

3. 约束松弛：在一些情况下，可以通过将一部分约束松弛为不等式，从而降低问题的复杂性。这可能会导致求解速度的提升，但需要权衡求解结果的质量。

4. 初始点选择：选择一个合适的初始点作为迭代的起点，可以影响收敛速度和成功率。一个好的初始点可能使优化算法更快地接近最优解。

5. 调整参数：二次规划求解器通常有一些参数可以调整，如学习率、容差等。通过调整这些参数，可以尝试加速求解过程并提高成功率。

6. 并行计算：利用多核处理器或分布式计算资源进行并行计算可以加速求解过程。一些求解器支持并行计算，可以利用这些功能来加速求解。

7. 内存管理：优化算法可能需要大量的内存来存储中间变量和计算结果。优化内存管理可以避免内存溢出和额外的开销。

8. 问题分解：对于大规模问题，可以考虑将问题分解成子问题，并分别求解。这可以减小每个子问题的规模，从而提高求解速度。

9. 启发式初始化：对于一些特定问题，可以使用启发式方法初始化变量，从而加速收敛。启发式初始化方法可能会更快地使问题趋近最优解。

10. 收敛准则：调整收敛准则可以影响算法的停止时间。更宽松的收敛准则可能导致更快的求解，但可能会影响求解结果的精度。

## 使用MPC进行车辆控制时，如果考虑滑移率和轮胎附着系数，应当如何设计控制器？

## 如果测试得知执行器存在响应滞后，应该如何在控制器设计上调整改进控制性能？
从转向角指令下发到实际到达该转向角度的时间。这个可以通过简单的动态系统进行建模，并且整合到车辆模型中去。一种方法就是将使用车辆模型，根据延迟时间推算延迟时间后的车辆状态，这个车辆状态就是MPC计算的新初始状态。